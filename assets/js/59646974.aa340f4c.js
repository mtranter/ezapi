"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[950],{3905:(e,r,t)=>{t.d(r,{Zo:()=>p,kt:()=>w});var n=t(7294);function a(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function o(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function i(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?o(Object(t),!0).forEach((function(r){a(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function d(e,r){if(null==e)return{};var t,n,a=function(e,r){if(null==e)return{};var t,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)t=o[n],r.indexOf(t)>=0||(a[t]=e[t]);return a}(e,r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)t=o[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=n.createContext({}),l=function(e){var r=n.useContext(s),t=r;return e&&(t="function"==typeof e?e(r):i(i({},r),e)),t},p=function(e){var r=l(e.components);return n.createElement(s.Provider,{value:r},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var r=e.children;return n.createElement(n.Fragment,{},r)}},m=n.forwardRef((function(e,r){var t=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,p=d(e,["components","mdxType","originalType","parentName"]),c=l(t),m=a,w=c["".concat(s,".").concat(m)]||c[m]||u[m]||o;return t?n.createElement(w,i(i({ref:r},p),{},{components:t})):n.createElement(w,i({ref:r},p))}));function w(e,r){var t=arguments,a=r&&r.mdxType;if("string"==typeof e||a){var o=t.length,i=new Array(o);i[0]=m;var d={};for(var s in r)hasOwnProperty.call(r,s)&&(d[s]=r[s]);d.originalType=e,d[c]="string"==typeof e?e:a,i[1]=d;for(var l=2;l<o;l++)i[l]=t[l];return n.createElement.apply(null,i)}return n.createElement.apply(null,t)}m.displayName="MDXCreateElement"},3510:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>d,toc:()=>l});var n=t(7462),a=(t(7294),t(3905));const o={sidebar_position:1,slug:"ez-api-middleware",description:"Using EZAPI Middleware",title:"Usage"},i="Middleware",d={unversionedId:"middleware/middleware",id:"middleware/middleware",title:"Usage",description:"Using EZAPI Middleware",source:"@site/docs/middleware/middleware.md",sourceDirName:"middleware",slug:"/middleware/ez-api-middleware",permalink:"/ezapi/middleware/ez-api-middleware",draft:!1,editUrl:"https://github.com/mtranter/ezapi/tree/main/docs/docs/middleware/middleware.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,slug:"ez-api-middleware",description:"Using EZAPI Middleware",title:"Usage"},sidebar:"tutorialSidebar",previous:{title:"Middleware",permalink:"/ezapi/category/middleware"},next:{title:"Custom Middleware",permalink:"/ezapi/middleware/ez-api-custom-middleware"}},s={},l=[{value:"JsonParserMiddlerware",id:"jsonparsermiddlerware",level:3},{value:"ZodMiddleware",id:"zodmiddleware",level:3}],p={toc:l},c="wrapper";function u(e){let{components:r,...t}=e;return(0,a.kt)(c,(0,n.Z)({},p,t,{components:r,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"middleware"},"Middleware"),(0,a.kt)("p",null,"EZApi has a composable, extensible, strongly typed middleware system."),(0,a.kt)("p",null,"The quickest way to grok how to use middleware is by example. The below examples show how to use two of the middlewares distributed with EZAPI: ",(0,a.kt)("inlineCode",{parentName:"p"},"JsonParserMiddlerware")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"ZodMiddleware"),"."),(0,a.kt)("h3",{id:"jsonparsermiddlerware"},"JsonParserMiddlerware"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"JsonParserMiddlerware")," allows us to expect JSON requests and return JSON responses."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { RouteBuilder } from "@ezapi/router-core";\nimport { JsonParserMiddlerware } from "@ezapi/json-middleware";\n\nconst routeDefinition = RouteBuilder.withMiddleware(\n  JsonParserMiddlerware\n)\n  .route("getPersonById", "GET", "/people/{id:int}")\n  .route("createPerson", "POST", "/people")\n  .build({\n    getPersonById: async (r) => {\n      const person = await someRepo.getPerson(r.pathParams.id);\n      return person\n        ? Ok(person)\n        : NotFound(`Person ${r.pathParams.id} not found`);\n    },\n    createPerson: async (req) => {\n      const personRequest = req.jsonBody;\n      const newPerson = { id: genId(), ...personRequest };\n      await someRepo.putPerson(newPerson);\n      return Created(newPerson, `/people/${newPerson.id}`);\n    },\n  });\n')),(0,a.kt)("p",null,"The Json middleware checks the content-type headers are appropriate, and parses the incoming request body to JSON and attaches it to a property called ",(0,a.kt)("inlineCode",{parentName:"p"},"jsonBody")," on the request object."),(0,a.kt)("h3",{id:"zodmiddleware"},"ZodMiddleware"),(0,a.kt)("p",null,"The above is OK.. But we are trusting that the client is sending us a valid ",(0,a.kt)("inlineCode",{parentName:"p"},"personRequesst")," object.\nThe ",(0,a.kt)("inlineCode",{parentName:"p"},"ZodMiddleware")," lets us improve on this somewhat."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { RouteBuilder, Ok, NotFound, Created } from "@ezapi/router-core";\nimport { JsonParserMiddlerware } from "@ezapi/json-middleware";\nimport { ZodMiddleware } from "@ezapi/zod-middleware";\nimport { z } from "zod";\n\nconst PersonRequestSchema = z.object({\n  name: z.string(),\n});\n\nconst routeDefinition = RouteBuilder.withMiddleware(\n  JsonParserMiddlerware\n)\n  .route("createPerson", "POST", "/people", ZodMiddleware(PersonRequestSchema))\n  .build({\n    createPerson: async (req) => {\n      const personRequest = req.safeBody;\n      const newPerson = { id: genId(), ...personRequest };\n      await someRepo.putPerson(newPerson);\n      return Created(newPerson, `/people/${newPerson.id}`);\n    },\n  });\n')),(0,a.kt)("p",null,"This improves on the ",(0,a.kt)("inlineCode",{parentName:"p"},"JsonParserMiddlerware")," example. In this case, the ",(0,a.kt)("inlineCode",{parentName:"p"},"ZodMiddleware")," with a valid ",(0,a.kt)("inlineCode",{parentName:"p"},"Zod")," schema object is provided to a specific route.\nThe Zod Schema validates the incoming JSON to correctness, and if correct, attaches the parsed, typesafe payload to the ",(0,a.kt)("inlineCode",{parentName:"p"},"safeBody")," property on the request.\nIf the incoming request is invalid, ezapi will return a 400 with a validation message to the client."),(0,a.kt)("p",null,"Note that the ",(0,a.kt)("inlineCode",{parentName:"p"},"JsonParserMiddlerware")," is still provided at a global route level - that is, it will be used across all routes. The ",(0,a.kt)("inlineCode",{parentName:"p"},"ZodMiddleware")," has an expectation that a ",(0,a.kt)("inlineCode",{parentName:"p"},"jsonBody")," property will exist on the incoming request, and this expectation will be checked at compile time. Its this composability, that allows routeHandlers to track which middleware have been added into the request pipeline."))}u.isMDXComponent=!0}}]);